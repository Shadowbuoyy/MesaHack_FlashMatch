<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashMatch - Data Visualization Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.6.1/d3.min.js"></script>
    <style>
        body {
            font-family: "Trebuchet MS", Arial, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            overflow-x: auto;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            width: 95%;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .panel {
            background: linear-gradient(135deg, #1a1a1a, #252525);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
            box-shadow: 0 8px 32px rgba(0, 227, 204, 0.1);
        }
        h1 {
            text-align: center;
            color: #00e3cc;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #00e3cc, #00bfac);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            color: #00e3cc;
            margin-bottom: 15px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #404040;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #00e3cc;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00e3cc;
            display: block;
        }
        .stat-label {
            color: #888;
            margin-top: 5px;
        }
        .knowledge-map {
            width: 100%;
            height: 500px;
            background: radial-gradient(circle at center, #1a1a1a 0%, #0f0f0f 100%);
            border-radius: 10px;
            border: 1px solid #333;
        }
        .realtime-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #00e3cc;
            color: #000;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        .learning-path {
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #00e3cc;
        }
        .path-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 227, 204, 0.1);
            border-radius: 8px;
        }
        .step-number {
            width: 30px;
            height: 30px;
            background: #00e3cc;
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .chart-container-large {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 0 auto;
            max-width: 1200px;
        }

        canvas {
            max-height: 400px;
            width: 100% !important;
            height: auto !important;
        }

        .chart-container-large canvas {
            max-height: 400px;
        }
        .heatmap-container {
            position: relative;
            height: 400px;
        }
        .concept-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .concept-node:hover {
            stroke: #00e3cc;
            stroke-width: 3px;
        }
        .link {
            stroke: #666;
            stroke-opacity: 0.6;
            stroke-width: 2;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00e3cc;
            border-radius: 8px;
            pointer-events: none;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        .progress-ring circle {
            stroke: #333;
            stroke-width: 8;
            fill: transparent;
            r: 45;
            cx: 60;
            cy: 60;
        }
        .progress-ring .progress {
            stroke: #00e3cc;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        /* Forgetting Terms Styles */
        .forgetting-terms {
            max-height: 300px;
            overflow-y: auto;
        }

        .forgetting-term {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #2a1a1a, #3a2525);
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
            transition: all 0.3s ease;
        }

        .forgetting-term:hover {
            background: linear-gradient(135deg, #3a2525, #4a3535);
            transform: translateX(5px);
        }

        .term-info {
            flex: 1;
        }

        .term-text {
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
        }

        .term-details {
            font-size: 12px;
            color: #ccc;
        }

        .forgetting-risk {
            text-align: right;
            min-width: 60px;
        }

        .risk-level {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .risk-high { color: #ff6b6b; }
        .risk-medium { color: #ffa726; }
        .risk-low { color: #66bb6a; }

        .last-seen {
            font-size: 11px;
            color: #888;
        }

        .no-data-message {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
                max-width: 1000px;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                max-width: 600px;
            }
            
            .chart-container-large {
                height: 300px;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>FlashMatch Analytics Dashboard</h1>
    <div class="realtime-indicator">LIVE</div>
    
    <div class="dashboard">
        <!-- Overall Performance Stats -->
        <div class="panel full-width">
            <h2>Performance Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="totalConcepts">0</span>
                    <div class="stat-label">Concepts Learned</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="masteryRate">0%</span>
                    <div class="stat-label">Mastery Rate</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="studyStreak">0</span>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="avgSession">0s</span>
                    <div class="stat-label">Avg Session</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="totalGames">0</span>
                    <div class="stat-label">Games Played</div>
                </div>
            </div>
        </div>


        <!-- Learning Progress Chart -->
        <div class="panel full-width">
            <h2>Weekly Progress</h2>
            <div class="chart-container-large">
                <canvas id="progressChart"></canvas>
            </div>
        </div>


        <!-- Learning Path Recommendation -->
        <div class="panel full-width">
            <h2>Personalized Learning Path</h2>
            <div class="learning-path" id="learningPath">
                <div class="path-step">
                    <div class="step-number">1</div>
                    <div>
                        <strong>Start Playing Games</strong><br>
                        <small>No data yet • Play some games to see recommendations</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Learning Analytics -->
        <div class="panel">
            <h2>Session Analytics</h2>
            <div style="text-align: center;">
                <svg class="progress-ring">
                    <circle class="progress" id="sessionProgress"></circle>
                    <text x="60" y="65" fill="#00e3cc" font-size="20" font-weight="bold" text-anchor="middle" id="sessionScore">0%</text>
                    <text x="60" y="80" fill="#888" font-size="12" text-anchor="middle">Overall Accuracy</text>
                </svg>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" style="font-size: 1.5rem;" id="totalCards">0</span>
                    <div class="stat-label">Total Cards</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" style="font-size: 1.5rem;" id="avgTime">0s</span>
                    <div class="stat-label">Avg Time</div>
                </div>
            </div>
        </div>

        <!-- Memory Retention Analysis -->
        <div class="panel">
            <h2>Terms at Risk of Forgetting</h2>
            <div id="forgettingTerms" class="forgetting-terms">
                <div class="no-data-message">Play more games to see retention analysis</div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Data extraction and processing functions
        function getLeaderboardData() {
            return JSON.parse(localStorage.getItem('flashmatch.leaderboard') || '[]');
        }

        function calculateAnalytics() {
            const leaderboard = getLeaderboardData();
            
            if (leaderboard.length === 0) {
                return {
                    totalGames: 0,
                    totalConcepts: 0,
                    masteryRate: 0,
                    studyStreak: 0,
                    totalTime: 0,
                    avgSession: 0,
                    topicsPlayed: [],
                    recentPerformance: [],
                    weeklyProgress: [],
                    topicMastery: {},
                    gameModeStats: { static: 0, moving: 0 }
                };
            }

            // Calculate basic stats
            const totalGames = leaderboard.length;
            const totalConcepts = leaderboard.reduce((sum, game) => sum + game.score, 0);
            const totalMistakes = leaderboard.reduce((sum, game) => sum + game.mistakes, 0);
            const totalAttempts = totalConcepts + totalMistakes;
            const masteryRate = totalAttempts > 0 ? Math.round((totalConcepts / totalAttempts) * 100) : 0;
            
            // Calculate total time
            const totalTimeSeconds = leaderboard.reduce((sum, game) => sum + game.time, 0);
            const totalTimeHours = Math.round(totalTimeSeconds / 3600 * 10) / 10;
            
            // Calculate average session time
            const avgSessionSeconds = Math.round(totalTimeSeconds / totalGames);
            
            // Get unique topics
            const topicsPlayed = [...new Set(leaderboard.map(game => game.topic))];
            
            // Calculate topic mastery
            const topicMastery = {};
            topicsPlayed.forEach(topic => {
                const topicGames = leaderboard.filter(game => game.topic === topic);
                const topicConcepts = topicGames.reduce((sum, game) => sum + game.score, 0);
                const topicMistakes = topicGames.reduce((sum, game) => sum + game.mistakes, 0);
                const topicAttempts = topicConcepts + topicMistakes;
                topicMastery[topic] = topicAttempts > 0 ? Math.round((topicConcepts / topicAttempts) * 100) : 0;
            });
            
            // Calculate game mode stats
            const gameModeStats = {
                static: leaderboard.filter(game => game.mode === 'Static Grid').length,
                moving: leaderboard.filter(game => game.mode === 'Moving Cards').length
            };
            
            // Calculate recent performance (last 7 games)
            const recentGames = leaderboard.slice(-7);
            const recentPerformance = recentGames.map(game => ({
                score: game.score,
                time: game.time,
                accuracy: game.accuracy,
                topic: game.topic,
                mode: game.mode,
                date: new Date(game.date)
            }));
            
            // Calculate weekly progress (group by week)
            const weeklyProgress = calculateWeeklyProgress(leaderboard);
            
            // Calculate study streak
            const studyStreak = calculateStudyStreak(leaderboard);
            
            return {
                totalGames,
                totalConcepts,
                masteryRate,
                studyStreak,
                totalTime: totalTimeHours,
                avgSession: avgSessionSeconds,
                topicsPlayed,
                recentPerformance,
                weeklyProgress,
                topicMastery,
                gameModeStats,
                totalAttempts,
                totalMistakes
            };
        }

        function calculateWeeklyProgress(leaderboard) {
            const weeks = {};
            leaderboard.forEach(game => {
                const date = new Date(game.date);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!weeks[weekKey]) {
                    weeks[weekKey] = { concepts: 0, sessions: 0, accuracy: 0 };
                }
                weeks[weekKey].concepts += game.score;
                weeks[weekKey].sessions += 1;
                weeks[weekKey].accuracy += game.accuracy;
            });
            
            // Convert to array and sort by date
            return Object.entries(weeks)
                .map(([week, data]) => ({
                    week,
                    concepts: data.concepts,
                    sessions: data.sessions,
                    accuracy: Math.round(data.accuracy / data.sessions)
                }))
                .sort((a, b) => new Date(a.week) - new Date(b.week))
                .slice(-7); // Last 7 weeks
        }

        function calculateStudyStreak(leaderboard) {
            if (leaderboard.length === 0) return 0;
            
            const dates = leaderboard
                .map(game => new Date(game.date).toDateString())
                .sort((a, b) => new Date(b) - new Date(a));
            
            const uniqueDates = [...new Set(dates)];
            let streak = 0;
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            // Check if played today or yesterday
            if (uniqueDates.includes(today) || uniqueDates.includes(yesterday)) {
                streak = 1;
                for (let i = 1; i < uniqueDates.length; i++) {
                    const currentDate = new Date(uniqueDates[i]);
                    const previousDate = new Date(uniqueDates[i - 1]);
                    const diffTime = currentDate - previousDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        streak++;
                    } else {
                        break;
                    }
                }
            }
            
            return streak;
        }

        // Define all functions before using them
        function getHeatmapColor(value) {
            const colors = [
                '#ff6b6b', '#ff8a65', '#ffa726', '#ffcc02', 
                '#d4ed57', '#8bc34a', '#66bb6a', '#4caf50'
            ];
            const index = Math.floor(value * (colors.length - 1));
            return colors[index];
        }

        function createProgressChart() {
            const analytics = calculateAnalytics();
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            // Prepare data for the last 7 days
            const last7Days = [];
            const conceptsData = [];
            const sessionsData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'short' });
                last7Days.push(dateStr);
                
                // Count concepts and sessions for this day
                const dayGames = analytics.recentPerformance.filter(game => {
                    const gameDate = new Date(game.date);
                    return gameDate.toDateString() === date.toDateString();
                });
                
                conceptsData.push(dayGames.reduce((sum, game) => sum + game.score, 0));
                sessionsData.push(dayGames.length);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Concepts Learned',
                        data: conceptsData,
                        borderColor: '#00e3cc',
                        backgroundColor: 'rgba(0, 227, 204, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Games Played',
                        data: sessionsData,
                        borderColor: '#6b8afd',
                        backgroundColor: 'rgba(107, 138, 253, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#888888' },
                            grid: { color: '#333333' }
                        },
                        x: {
                            ticks: { color: '#888888' },
                            grid: { color: '#333333' }
                        }
                    }
                }
            });
        }

        function updateForgettingTerms() {
            const leaderboard = getLeaderboardData();
            const container = document.getElementById('forgettingTerms');
            
            if (leaderboard.length === 0) {
                container.innerHTML = '<div class="no-data-message">Play more games to see retention analysis</div>';
                return;
            }

            // Extract all unique terms from games
            const termPerformance = {};
            const now = new Date();
            
            leaderboard.forEach(game => {
                // This is a simplified approach - in a real app you'd track individual terms
                // For now, we'll use the topic as a proxy for terms
                const topic = game.topic;
                const daysSincePlayed = Math.floor((now - new Date(game.date)) / (1000 * 60 * 60 * 24));
                const accuracy = game.accuracy;
                
                if (!termPerformance[topic]) {
                    termPerformance[topic] = {
                        topic: topic,
                        lastPlayed: game.date,
                        daysSince: daysSincePlayed,
                        accuracy: accuracy,
                        gamesPlayed: 1,
                        totalAccuracy: accuracy
                    };
                } else {
                    termPerformance[topic].gamesPlayed++;
                    termPerformance[topic].totalAccuracy += accuracy;
                    termPerformance[topic].accuracy = Math.round(termPerformance[topic].totalAccuracy / termPerformance[topic].gamesPlayed);
                    if (daysSincePlayed < termPerformance[topic].daysSince) {
                        termPerformance[topic].daysSince = daysSincePlayed;
                        termPerformance[topic].lastPlayed = game.date;
                    }
                }
            });

            // Calculate forgetting risk for each term
            const terms = Object.values(termPerformance).map(term => {
                let riskLevel = 'low';
                let riskScore = 0;
                
                // Risk factors: days since last played, accuracy, number of games
                if (term.daysSince > 7) riskScore += 3;
                else if (term.daysSince > 3) riskScore += 2;
                else if (term.daysSince > 1) riskScore += 1;
                
                if (term.accuracy < 50) riskScore += 3;
                else if (term.accuracy < 70) riskScore += 2;
                else if (term.accuracy < 85) riskScore += 1;
                
                if (term.gamesPlayed < 2) riskScore += 2;
                else if (term.gamesPlayed < 4) riskScore += 1;
                
                if (riskScore >= 5) riskLevel = 'high';
                else if (riskScore >= 3) riskLevel = 'medium';
                
                return {
                    ...term,
                    riskLevel,
                    riskScore
                };
            });

            // Sort by risk (highest first)
            terms.sort((a, b) => b.riskScore - a.riskScore);

            // Display terms
            if (terms.length === 0) {
                container.innerHTML = '<div class="no-data-message">No terms to analyze yet</div>';
                return;
            }

            container.innerHTML = terms.map(term => `
                <div class="forgetting-term">
                    <div class="term-info">
                        <div class="term-text">${term.topic}</div>
                        <div class="term-details">
                            Accuracy: ${term.accuracy}% • Games: ${term.gamesPlayed}
                        </div>
                        <div class="last-seen">
                            Last played: ${term.daysSince === 0 ? 'Today' : term.daysSince === 1 ? 'Yesterday' : `${term.daysSince} days ago`}
                        </div>
                    </div>
                    <div class="forgetting-risk">
                        <div class="risk-level risk-${term.riskLevel}">
                            ${term.riskLevel.toUpperCase()}
                        </div>
                        <div class="last-seen">Risk</div>
                    </div>
                </div>
            `).join('');
        }


        function updateSessionProgress(percentage) {
            const circle = document.getElementById('sessionProgress');
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }

        function simulateRealTimeUpdates() {
            setInterval(() => {
                // Refresh data every 5 seconds to show any new games
                updateAllData();
            }, 5000);
        }


        function updateAllData() {
            const analytics = calculateAnalytics();
            
            // Update performance overview
            document.getElementById('totalConcepts').textContent = analytics.totalConcepts;
            document.getElementById('masteryRate').textContent = analytics.masteryRate + '%';
            document.getElementById('studyStreak').textContent = analytics.studyStreak;
            document.getElementById('avgSession').textContent = analytics.avgSession + 's';
            document.getElementById('totalGames').textContent = analytics.totalGames;
            
            // Update session analytics
            document.getElementById('sessionScore').textContent = analytics.masteryRate + '%';
            document.getElementById('totalCards').textContent = analytics.totalConcepts + analytics.totalMistakes;
            document.getElementById('avgTime').textContent = analytics.avgSession + 's';
            updateSessionProgress(analytics.masteryRate);
            
            // Update learning path
            updateLearningPath(analytics);
            
            // Update forgetting terms
            updateForgettingTerms();
        }

        function updateLearningPath(analytics) {
            const learningPath = document.getElementById('learningPath');
            
            if (analytics.totalGames === 0) {
                learningPath.innerHTML = `
                    <div class="path-step">
                        <div class="step-number">1</div>
                        <div>
                            <strong>Start Playing Games</strong><br>
                            <small>No data yet • Play some games to see recommendations</small>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Generate recommendations based on performance
            const recommendations = [];
            
            // Find topics that need improvement
            const weakTopics = Object.entries(analytics.topicMastery)
                .filter(([topic, mastery]) => mastery < 70)
                .sort((a, b) => a[1] - b[1])
                .slice(0, 3);
            
            weakTopics.forEach(([topic, mastery], index) => {
                recommendations.push({
                    step: index + 1,
                    title: `Review ${topic}`,
                    description: `Current mastery: ${mastery}% • Focus on this topic`,
                    priority: 'high'
                });
            });
            
            // Add new topic suggestions
            const allTopics = ['Biology', 'Chemistry', 'Physics', 'Computer Science', 'History', 'Mathematics'];
            const newTopics = allTopics.filter(topic => !analytics.topicsPlayed.includes(topic)).slice(0, 2);
            
            newTopics.forEach((topic, index) => {
                recommendations.push({
                    step: recommendations.length + 1,
                    title: `Try ${topic}`,
                    description: `New topic • Expand your knowledge`,
                    priority: 'medium'
                });
            });
            
            // Render recommendations
            learningPath.innerHTML = recommendations.map(rec => `
                <div class="path-step">
                    <div class="step-number">${rec.step}</div>
                    <div>
                        <strong>${rec.title}</strong><br>
                        <small>${rec.description}</small>
                    </div>
                </div>
            `).join('');
        }

        // Initialize everything when DOM is loaded
        window.addEventListener('load', function() {
            updateAllData();
            createProgressChart();
            simulateRealTimeUpdates();
        });
    </script>
</body>
</html>